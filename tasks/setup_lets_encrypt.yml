---
## https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/SSL-on-amazon-linux-2.html
## https://github.com/geerlingguy/ansible-role-certbot/blob/master/molecule/default/playbook-standalone-nginx-aws.yml

- name: Update apt cache.
  apt: update_cache=true cache_valid_time=600
  when: ansible_os_family == 'Debian'
  changed_when: false

- name: Install dependencies (RedHat).
  yum: name={{ item }} state=present
  when: ansible_os_family == 'RedHat'
  with_items:
    - cronie
    - https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm

- name: Install cron (Debian).
  apt: name=cron state=present
  when: ansible_os_family == 'Debian'

- name: Create Lets Encrypt Certificates
  block:
    - name: Install Certs
      include_role:
        name: geerlingguy.certbot
      vars:
        certbot_admin_email: "{{ letsencrypt_certbot_admin_email }}"
        certbot_create_if_missing: "{{ letsencrypt_certbot_create_if_missing }}"
        certbot_create_standalone_stop_services: "{{ letsencrypt_certbot_create_standalone_stop_services }}"
        certbot_certs:
            - domains:
              - "{{ keycloak_domain_name }}"
        when: letsencrypt_certbot_enabled

    - name: Check that the cert.pem exists
      stat:
        path:  "/etc/letsencrypt/live/{{ keycloak_domain_name }}/cert.pem"
      register: cert_stat_result
    
    - name: Check that the privkey.pem exists
      stat:
        path:  "/etc/letsencrypt/live/{{ keycloak_domain_name }}/privkey.pem"
      register: privkey_stat_result

    - name: Set files
      set_fact:
        keycloak_tls_cert: "/etc/letsencrypt/live/{{ keycloak_domain_name }}/cert.pem"
        keycloak_tls_key: "/etc/letsencrypt/live/{{ keycloak_domain_name }}/privkey.pem"
      when: privkey_stat_result.stat.exists == true and cert_stat_result.stat.exists